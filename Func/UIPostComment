using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using UnityEngine;
using UnityEngine.UI;

public class UIPostComment : AddressableUI
{
    [SerializeField] GameObject CommentitemPrefab;
    [SerializeField] RectTransform RootUIrect;
    [SerializeField] ImageDragScrollView scrollview;
    [SerializeField] Button Btn_enter;
    [SerializeField] RectTransform CommentParent;
    [SerializeField] InputField Inputfield_comment;

    Dictionary<int, List<CommentItem>> Comment_Data = new Dictionary<int, List<CommentItem>>();
    Dictionary<int, Stack<GameObject>> Comment_Stack_Pool = new Dictionary<int, Stack<GameObject>>();
    Stack<GameObject> Comment_Stack;
    Stack<GameObject> CommentPool;
    List<CommentItem> Parent_object;
    List<CommentItem> Comment_list;
    List<reply> request_reply_Data;
    public bool comment_location_state;
    private int comment_id_number = 1;
    public int parent_top_comment_id;

    public override void OpenUI()
    {
        comment_location_state = true;
        CommentPool = new Stack<GameObject>();
        //RequestComment();
        Inputfield_comment.onValueChanged.AddListener(ObservedInputField);
        Btn_enter.onClick.AddListener(OnClickAddComment);
        Btn_enter.gameObject.SetActive(false);
        scrollview.Init(RootUIrect.rect.height);
        base.OpenUI();
    }
    void ObservedInputField(string text)
    {
        if (String.IsNullOrEmpty(text))
            Btn_enter.gameObject.SetActive(false);
        else
            Btn_enter.gameObject.SetActive(true);
    }
    void RequestComment()
    {

    }
    void ResponseServer(OVRSimpleJSON.JSONNode data)
    {
        CommentData jsondata = JsonUtility.FromJson<CommentData>(data);
        request_reply_Data = jsondata.reply.ToList();

        for (int i = 0; i < request_reply_Data.Count; i++)
        {
            reply newcomment = new reply();
            newcomment = request_reply_Data[i];
            CommentItem newcommented = Instantiate(CommentitemPrefab, CommentParent).GetComponent<CommentItem>();
            if (newcomment.top_comment_id == 0)
            {
                newcommented.SetCommentData(newcomment);
                Comment_list = new List<CommentItem>();
                Comment_list.Add(newcommented);
                Comment_Data.Add(newcomment.comment_id, Comment_list);
                newcommented.gameObject.SetActive(true);
            }
            else
            {
                Comment_list = Comment_Data[parent_top_comment_id];
                Comment_list.Add(newcommented);
                Parent_object[0].SetReCommentCount(Comment_list.Count - 1);
                newcommented.SetCommentData(newcomment, Parent_object[0].gameObject.transform.GetSiblingIndex());
                newcommented.gameObject.SetActive(false);
            }
            comment_id_number++;
        }
    }
    /// <summary>
    /// 데이터를 읽어오는 구문. 형식 및 초기화는 Struct 확인 후 추가 구현 및 변경 필요.(수신부)
    /// </summary>
    /// <param name="newcomment"></param>
    void GetRecommentData(reply[] newcomment)
    {
        for (int i = 0; i < newcomment.Length; i++)
        {
            CommentItem newcommented = new CommentItem();
            if (newcomment[i].top_comment_id == 0)
            {
                newcommented.SetCommentData(newcomment[i]);
                Comment_list = new List<CommentItem>();
                Comment_list.Add(newcommented);
                Comment_Data.Add(newcomment[i].comment_id, Comment_list);
                newcommented.gameObject.SetActive(true);
            }
            else
            {
                Comment_list = Comment_Data[parent_top_comment_id];
                Comment_list.Add(newcommented);
                Parent_object[0].SetReCommentCount(Comment_list.Count - 1);
                newcommented.SetCommentData(newcomment[i], Parent_object[0].gameObject.transform.GetSiblingIndex());
                newcommented.gameObject.SetActive(false);
            }
            comment_id_number++;
        }
    }

    /// <summary>
    /// 해당 댓글의 대댓글 데이터를 가져와서 오브젝트에 데이터를 할당 및 회수 하는 구문.
    /// </summary>
    /// <param name="parentindex"> : Top_comment_ID</param>
    /// <param name="state"> : 대댓글 활성화 유무 true : 댓글보기 false : 댓글닫기</param>
    public void SetRcommentDIsplay(int parentindex, bool state)
    {
        if (Comment_Data.TryGetValue(parentindex, out Comment_list))
        {
            for (int i = 1; i < Comment_list.Count; i++)
            {
                if (state)
                {
                    CommentItem newcommented = PopCommentPool().GetComponent<CommentItem>();
                    Parent_object = Comment_Data[parentindex];
                    newcommented.SetCommentData(Comment_list[Comment_list.Count - i].thiscomment, Parent_object[0].gameObject.transform.GetSiblingIndex());

                    if (Comment_Stack_Pool.TryGetValue(parentindex, out Comment_Stack))
                    {
                        Comment_Stack.Push(newcommented.gameObject);
                    }
                    else
                    {
                        Comment_Stack = new Stack<GameObject>();
                        Comment_Stack.Push(newcommented.gameObject);
                        Comment_Stack_Pool.Add(parentindex, Comment_Stack);
                    }
                    newcommented.gameObject.SetActive(true);
                    LayoutRebuilder.ForceRebuildLayoutImmediate(newcommented.gameObject.GetComponent<RectTransform>());
                }
                else
                {
                    if (Comment_Stack_Pool.TryGetValue(parentindex, out Comment_Stack))
                    {
                        CommentItem newcommented = Comment_Stack.Pop().GetComponent<CommentItem>();
                        Comment_list[i].thiscomment = newcommented.thiscomment;
                        newcommented.gameObject.SetActive(false);
                        newcommented.gameObject.transform.SetAsLastSibling();
                        CommentPool.Push(newcommented.gameObject);
                    }
                }
            }
        }
    }
    /// <summary>
    /// 댓글 데이터를 추가 구문.(전송부)
    /// </summary>
    public void OnClickAddComment()
    {
        reply newcomment = new reply();
        newcomment.comment_id = comment_id_number;
        newcomment.user_nickname = "호랑이";
        newcomment.comment = Inputfield_comment.text;
        newcomment.uploadtime = float.Parse(DateTime.Now.ToString("HHmmss"));
        newcomment.bool_like = false;
        CommentItem newcommented;
        if (comment_location_state)
        {
            newcommented = PopCommentPool().GetComponent<CommentItem>();
            newcommented.SetCommentData(newcomment);
            Comment_list = new List<CommentItem>();
            Comment_list.Add(newcommented);
            Comment_Data.Add(newcomment.comment_id, Comment_list);
            newcommented.transform.SetAsFirstSibling();
            newcommented.gameObject.SetActive(true);
            LayoutRebuilder.ForceRebuildLayoutImmediate(newcommented.gameObject.GetComponent<RectTransform>());
        }
        else
        {
            Parent_object = Comment_Data[parent_top_comment_id];
            newcomment.top_comment_id = parent_top_comment_id;
            newcommented = new CommentItem();
            newcommented.thiscomment = newcomment;
            if (Parent_object[0].recommentactivestate == true)
            {
                CommentItem copy_comment = PopCommentPool().GetComponent<CommentItem>();
                copy_comment.SetCommentData(newcomment, Parent_object[0].gameObject.transform.GetSiblingIndex());
                if (Comment_Stack_Pool.TryGetValue(parent_top_comment_id, out Comment_Stack))
                {
                    CommentItem comment_copy = new CommentItem();
                    Comment_Stack.Push(copy_comment.gameObject);
                }

                copy_comment.gameObject.SetActive(true);
                LayoutRebuilder.ForceRebuildLayoutImmediate(copy_comment.gameObject.GetComponent<RectTransform>());
            }
            Comment_list = Comment_Data[parent_top_comment_id];
            Comment_list.Add(newcommented);
            Parent_object[0].SetReCommentCount(Comment_list.Count - 1);

            comment_location_state = true;
        }
        Inputfield_comment.text = string.Empty;
        comment_id_number++;
    }

    GameObject PopCommentPool()
    {
        if (CommentPool.Count > 0)
            return CommentPool.Pop();
        else
        {
            GameObject newcommented = Instantiate(CommentitemPrefab, CommentParent);
            return newcommented;
        }
    }
}
public struct CommentData
{
    public string user_id;
    public string user_Profile_image_url;
    public string nickname;
    public string bread;
    public string title;
    public string body;
    public string tags;
    public int reply_cnt;
    public int empathy_cnt;
    public string createAt;
    public string updatedAt;
    public items[] items;
    public reply[] reply;
}

public struct items
{
    public int index;
    public string type;
    public string url;
}

public struct reply
{
    public int comment_id;
    public string user_id;
    public string user_nickname;
    public string comment;
    public bool bool_like;
    public float uploadtime;
    public int top_comment_id;
}
